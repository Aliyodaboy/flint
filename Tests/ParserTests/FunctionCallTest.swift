//
//  FunctionCallTest.swift
//  ParserTests
//
//  Created by Franklin Schrans on 12/22/17.
//

import XCTest
@testable import Parser
import AST
import Diagnostic

// Test :: (any) {
//   func foo(a: Int) -> Int {
//     foo(bar(1, 2), 3, 5 + bar(4, 6)); return 2;
//   }
// 
//   func bar(a: Int, b: Int) -> Int {
//     return a + b;
//   }
// }

class FunctionCallTest: XCTestCase, ParserTest {
  var tokens: [Token] = [AST.Token(kind: AST.Token.Kind.contract, sourceLocation: SourceLocation(line: 1, column: 1, length: 8)), AST.Token(kind: AST.Token.Kind.identifier("Test"), sourceLocation: SourceLocation(line: 1, column: 10, length: 4)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBrace), sourceLocation: SourceLocation(line: 1, column: 15, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 1, column: 16, length: 1)), AST.Token(kind: AST.Token.Kind.var, sourceLocation: SourceLocation(line: 2, column: 3, length: 3)), AST.Token(kind: AST.Token.Kind.identifier("data"), sourceLocation: SourceLocation(line: 2, column: 7, length: 4)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.colon), sourceLocation: SourceLocation(line: 2, column: 11, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 2, column: 13, length: 3)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 2, column: 16, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBrace), sourceLocation: SourceLocation(line: 3, column: 1, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 3, column: 2, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 4, column: 1, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Test"), sourceLocation: SourceLocation(line: 5, column: 1, length: 4)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.doubleColon), sourceLocation: SourceLocation(line: 5, column: 6, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBracket), sourceLocation: SourceLocation(line: 5, column: 8, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("any"), sourceLocation: SourceLocation(line: 5, column: 9, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBracket), sourceLocation: SourceLocation(line: 5, column: 12, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBrace), sourceLocation: SourceLocation(line: 5, column: 14, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 5, column: 15, length: 1)), AST.Token(kind: AST.Token.Kind.public, sourceLocation: SourceLocation(line: 6, column: 3, length: 6)), AST.Token(kind: AST.Token.Kind.mutating, sourceLocation: SourceLocation(line: 6, column: 10, length: 8)), AST.Token(kind: AST.Token.Kind.func, sourceLocation: SourceLocation(line: 6, column: 19, length: 4)), AST.Token(kind: AST.Token.Kind.identifier("foo"), sourceLocation: SourceLocation(line: 6, column: 24, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBracket), sourceLocation: SourceLocation(line: 6, column: 27, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("a"), sourceLocation: SourceLocation(line: 6, column: 28, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.colon), sourceLocation: SourceLocation(line: 6, column: 29, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 6, column: 31, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.comma), sourceLocation: SourceLocation(line: 6, column: 34, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("b"), sourceLocation: SourceLocation(line: 6, column: 36, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.colon), sourceLocation: SourceLocation(line: 6, column: 37, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 6, column: 39, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBracket), sourceLocation: SourceLocation(line: 6, column: 42, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBrace), sourceLocation: SourceLocation(line: 6, column: 44, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 6, column: 45, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("data"), sourceLocation: SourceLocation(line: 7, column: 5, length: 4)), AST.Token(kind: AST.Token.Kind.binaryOperator(AST.Token.Kind.BinaryOperator.equal), sourceLocation: SourceLocation(line: 7, column: 10, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("bar"), sourceLocation: SourceLocation(line: 7, column: 12, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBracket), sourceLocation: SourceLocation(line: 7, column: 15, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("a"), sourceLocation: SourceLocation(line: 7, column: 16, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.comma), sourceLocation: SourceLocation(line: 7, column: 17, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("b"), sourceLocation: SourceLocation(line: 7, column: 19, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBracket), sourceLocation: SourceLocation(line: 7, column: 20, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.semicolon), sourceLocation: SourceLocation(line: 7, column: 21, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 7, column: 22, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBrace), sourceLocation: SourceLocation(line: 8, column: 3, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 8, column: 4, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 9, column: 1, length: 1)), AST.Token(kind: AST.Token.Kind.func, sourceLocation: SourceLocation(line: 10, column: 3, length: 4)), AST.Token(kind: AST.Token.Kind.identifier("bar"), sourceLocation: SourceLocation(line: 10, column: 8, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBracket), sourceLocation: SourceLocation(line: 10, column: 11, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("a"), sourceLocation: SourceLocation(line: 10, column: 12, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.colon), sourceLocation: SourceLocation(line: 10, column: 13, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 10, column: 15, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.comma), sourceLocation: SourceLocation(line: 10, column: 18, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("b"), sourceLocation: SourceLocation(line: 10, column: 20, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.colon), sourceLocation: SourceLocation(line: 10, column: 21, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 10, column: 23, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBracket), sourceLocation: SourceLocation(line: 10, column: 26, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.arrow), sourceLocation: SourceLocation(line: 10, column: 28, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 10, column: 30, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBrace), sourceLocation: SourceLocation(line: 10, column: 34, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 10, column: 35, length: 1)), AST.Token(kind: AST.Token.Kind.return, sourceLocation: SourceLocation(line: 11, column: 5, length: 6)), AST.Token(kind: AST.Token.Kind.identifier("a"), sourceLocation: SourceLocation(line: 11, column: 12, length: 1)), AST.Token(kind: AST.Token.Kind.binaryOperator(AST.Token.Kind.BinaryOperator.plus), sourceLocation: SourceLocation(line: 11, column: 14, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("b"), sourceLocation: SourceLocation(line: 11, column: 16, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 11, column: 17, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBrace), sourceLocation: SourceLocation(line: 12, column: 3, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 12, column: 4, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 13, column: 1, length: 1)), AST.Token(kind: AST.Token.Kind.public, sourceLocation: SourceLocation(line: 14, column: 3, length: 6)), AST.Token(kind: AST.Token.Kind.func, sourceLocation: SourceLocation(line: 14, column: 10, length: 4)), AST.Token(kind: AST.Token.Kind.identifier("getData"), sourceLocation: SourceLocation(line: 14, column: 15, length: 7)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBracket), sourceLocation: SourceLocation(line: 14, column: 22, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBracket), sourceLocation: SourceLocation(line: 14, column: 23, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.arrow), sourceLocation: SourceLocation(line: 14, column: 25, length: 1)), AST.Token(kind: AST.Token.Kind.identifier("Int"), sourceLocation: SourceLocation(line: 14, column: 27, length: 3)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.openBrace), sourceLocation: SourceLocation(line: 14, column: 31, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 14, column: 32, length: 1)), AST.Token(kind: AST.Token.Kind.return, sourceLocation: SourceLocation(line: 15, column: 5, length: 6)), AST.Token(kind: AST.Token.Kind.identifier("data"), sourceLocation: SourceLocation(line: 15, column: 12, length: 4)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 15, column: 16, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBrace), sourceLocation: SourceLocation(line: 16, column: 3, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 16, column: 4, length: 1)), AST.Token(kind: AST.Token.Kind.punctuation(AST.Token.Kind.Punctuation.closeBrace), sourceLocation: SourceLocation(line: 17, column: 1, length: 1)), AST.Token(kind: AST.Token.Kind.newline, sourceLocation: SourceLocation(line: 17, column: 2, length: 1))]

  var expectedAST: TopLevelModule =
TopLevelModule(declarations: [AST.TopLevelDeclaration.contractDeclaration(AST.ContractDeclaration(identifier: AST.Identifier(name: "Test", sourceLocation: SourceLocation(line: 1, column: 10, length: 4)), variableDeclarations: [AST.VariableDeclaration(identifier: AST.Identifier(name: "data", sourceLocation: SourceLocation(line: 2, column: 7, length: 4)), type: AST.Type(name: "Int", sourceLocation: SourceLocation(line: 2, column: 13, length: 3)), sourceLocation: SourceLocation(line: 2, column: 3, length: 3))], sourceLocation: SourceLocation(line: 1, column: 1, length: 8))), AST.TopLevelDeclaration.contractBehaviorDeclaration(AST.ContractBehaviorDeclaration(contractIdentifier: AST.Identifier(name: "Test", sourceLocation: SourceLocation(line: 5, column: 1, length: 4)), callerCapabilities: [AST.CallerCapability(name: "any", sourceLocation: SourceLocation(line: 5, column: 9, length: 3))], functionDeclarations: [AST.FunctionDeclaration(modifiers: [AST.Token(kind: AST.Token.Kind.public, sourceLocation: SourceLocation(line: 6, column: 3, length: 6)), AST.Token(kind: AST.Token.Kind.mutating, sourceLocation: SourceLocation(line: 6, column: 10, length: 8))], identifier: AST.Identifier(name: "foo", sourceLocation: SourceLocation(line: 6, column: 24, length: 3)), parameters: [AST.Parameter(identifier: AST.Identifier(name: "a", sourceLocation: SourceLocation(line: 6, column: 28, length: 1)), type: AST.Type(name: "Int", sourceLocation: SourceLocation(line: 6, column: 31, length: 3)), sourceLocation: SourceLocation(line: 6, column: 28, length: 1)), AST.Parameter(identifier: AST.Identifier(name: "b", sourceLocation: SourceLocation(line: 6, column: 36, length: 1)), type: AST.Type(name: "Int", sourceLocation: SourceLocation(line: 6, column: 39, length: 3)), sourceLocation: SourceLocation(line: 6, column: 36, length: 1))], resultType: nil, body: [AST.Statement.expression(AST.Expression.binaryExpression(AST.BinaryExpression(lhs: AST.Expression.identifier(AST.Identifier(name: "data", sourceLocation: SourceLocation(line: 7, column: 5, length: 4))), op: AST.Token(kind: AST.Token.Kind.binaryOperator(AST.Token.Kind.BinaryOperator.equal), sourceLocation: SourceLocation(line: 7, column: 10, length: 1)), rhs: AST.Expression.functionCall(AST.FunctionCall(identifier: AST.Identifier(name: "bar", sourceLocation: SourceLocation(line: 7, column: 12, length: 3)), arguments: [AST.Expression.identifier(AST.Identifier(name: "a", sourceLocation: SourceLocation(line: 7, column: 16, length: 1))), AST.Expression.identifier(AST.Identifier(name: "b", sourceLocation: SourceLocation(line: 7, column: 19, length: 1)))], sourceLocation: SourceLocation(line: 7, column: 12, length: 3))), sourceLocation: SourceLocation(line: 7, column: 5, length: 4))))], sourceLocation: SourceLocation(line: 6, column: 3, length: 6)), AST.FunctionDeclaration(modifiers: [], identifier: AST.Identifier(name: "bar", sourceLocation: SourceLocation(line: 10, column: 8, length: 3)), parameters: [AST.Parameter(identifier: AST.Identifier(name: "a", sourceLocation: SourceLocation(line: 10, column: 12, length: 1)), type: AST.Type(name: "Int", sourceLocation: SourceLocation(line: 10, column: 15, length: 3)), sourceLocation: SourceLocation(line: 10, column: 12, length: 1)), AST.Parameter(identifier: AST.Identifier(name: "b", sourceLocation: SourceLocation(line: 10, column: 20, length: 1)), type: AST.Type(name: "Int", sourceLocation: SourceLocation(line: 10, column: 23, length: 3)), sourceLocation: SourceLocation(line: 10, column: 20, length: 1))], resultType: Optional(AST.Type(name: "Int", sourceLocation: SourceLocation(line: 10, column: 30, length: 3))), body: [AST.Statement.returnStatement(AST.ReturnStatement(expression: Optional(AST.Expression.binaryExpression(AST.BinaryExpression(lhs: AST.Expression.identifier(AST.Identifier(name: "a", sourceLocation: SourceLocation(line: 11, column: 12, length: 1))), op: AST.Token(kind: AST.Token.Kind.binaryOperator(AST.Token.Kind.BinaryOperator.plus), sourceLocation: SourceLocation(line: 11, column: 14, length: 1)), rhs: AST.Expression.identifier(AST.Identifier(name: "b", sourceLocation: SourceLocation(line: 11, column: 16, length: 1))), sourceLocation: SourceLocation(line: 11, column: 12, length: 1)))), sourceLocation: SourceLocation(line: 11, column: 5, length: 6)))], sourceLocation: SourceLocation(line: 10, column: 3, length: 4)), AST.FunctionDeclaration(modifiers: [AST.Token(kind: AST.Token.Kind.public, sourceLocation: SourceLocation(line: 14, column: 3, length: 6))], identifier: AST.Identifier(name: "getData", sourceLocation: SourceLocation(line: 14, column: 15, length: 7)), parameters: [], resultType: Optional(AST.Type(name: "Int", sourceLocation: SourceLocation(line: 14, column: 27, length: 3))), body: [AST.Statement.returnStatement(AST.ReturnStatement(expression: Optional(AST.Expression.identifier(AST.Identifier(name: "data", sourceLocation: SourceLocation(line: 15, column: 12, length: 4)))), sourceLocation: SourceLocation(line: 15, column: 5, length: 6)))], sourceLocation: SourceLocation(line: 14, column: 3, length: 6))], sourceLocation: SourceLocation(line: 5, column: 1, length: 4)))])

  func testFunctionCall() {
    test()
  }

}
